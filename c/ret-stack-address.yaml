rules:
  - id: raptor-ret-stack-address
    metadata:
      author: Marco Ivaldi <raptor@0xdeadbeef.info>
      references:
        - https://cwe.mitre.org/data/definitions/562
        - https://github.com/struct/mms
        - https://www.sei.cmu.edu/downloads/sei-cert-c-coding-standard-2016-v01.pdf
        - https://docs.microsoft.com/en-us/cpp/sanitizers/asan-error-examples
        - https://rules.sonarsource.com/c/type/Bug/RSPEC-946
      confidence: LOW
      # NOTE: static variables matching apparently is not supported by Semgrep.
      # NOTE: multiple pointer assignments and other ways to persist after 
      # function returns (e.g., output parameter) are not covered.
    message: >-
      A function returns the address of a stack variable, which will cause
      unintended program behavior, typically in the form of a crash.
      Because local variables are allocated on the stack, when a program
      returns a pointer to a local variable, it is returning a stack
      address. A subsequent function call is likely to re-use this same
      stack address, thereby overwriting the value of the pointer, which no
      longer corresponds to the same variable since a function's stack
      frame is invalidated when it returns. At best this will cause the
      value of the pointer to change unexpectedly. In many cases it causes
      the program to crash the next time the pointer is dereferenced.
    severity: WARNING
    languages:
      - c
      - cpp
    pattern-either:
      - patterns:
        - pattern: return $PTR;
        - pattern-either:
          # array
          - pattern-inside: |
              $TYPE $PTR[$SIZE];
              ...
          - pattern-inside: |
              $TYPE $PTR[$SIZE] = $EXPR;
              ...
          # pointer to array
          - pattern-inside: |
              $TYPE $ARR[$SIZE];
              ...
              $PTR = $ARR;
              ...
          - pattern-inside: |
              $TYPE $ARR[$SIZE] = $EXPR;
              ...
              $PTR = $ARR;
              ...
      - patterns:
        # address of variable
        - pattern: return &$VAR;
        - pattern-either:
          - pattern-inside: |
              $TYPE $VAR;
              ...
          - pattern-inside: |
              $TYPE $VAR = $EXPR;
              ...
