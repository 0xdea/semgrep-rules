rules:
  - id: raptor-unterminated-string-strncpy-stpncpy
    metadata:
      author: Marco Ivaldi <raptor@0xdeadbeef.info>
      references:
        - https://cwe.mitre.org/data/definitions/170
        - https://cwe.mitre.org/data/definitions/126
        - https://g.co/kgs/PCHQjJ
        - https://www.sei.cmu.edu/downloads/sei-cert-c-coding-standard-2016-v01.pdf
      confidence: MEDIUM
    # NOTE: other functions that do not null-terminate the destination
    # buffer are not covered (e.g., read(), readlink(), etc.).
    message: >-
      The software does not terminate or incorrectly terminates a string or
      array with a NUL character or equivalent terminator.
      If there is no NUL character byte in the first n bytes of the source
      string, strncpy() and stpncpy() do not null-terminate the destination
      buffer. If the program does not explicitly terminate the destination
      buffer, this will almost certainly result in information disclosure,
      and possibly a buffer overflow condition, which may be exploited to
      execute arbitrary code.
    severity: WARNING
    languages:
      - c
      - cpp
    pattern-either:
      # strncpy 
      - patterns:
          - pattern: strncpy(...)
          - pattern-not-inside: |
              strncpy($DST, $SRC, $N);
              ...
              $DST[$POS] = NULL;
          - pattern-not-inside: |
              strncpy($DST, $SRC, $N);
              ...
              $DST[$POS] = '\0';
          - pattern-not-inside: |
              strncpy($DST, $SRC, $N);
              ...
              $DST[$POS] = 0;
      # stpncpy 
      - patterns:
          - pattern: stpncpy(...)
          - pattern-not-inside: |
              stpncpy($DST, $SRC, $N);
              ...
              $DST[$POS] = NULL;
          - pattern-not-inside: |
              stpncpy($DST, $SRC, $N);
              ...
              $DST[$POS] = '\0';
          - pattern-not-inside: |
              stpncpy($DST, $SRC, $N);
              ...
              $DST[$POS] = 0;
      # wcsncpy 
      - patterns:
          - pattern: wcsncpy(...)
          - pattern-not-inside: |
              wcsncpy($DST, $SRC, $N);
              ...
              $DST[$POS] = NULL;
          - pattern-not-inside: |
              wcsncpy($DST, $SRC, $N);
              ...
              $DST[$POS] = '\0';
          - pattern-not-inside: |
              wcsncpy($DST, $SRC, $N);
              ...
              $DST[$POS] = 0;
      # wcpncpy 
      - patterns:
          - pattern: wcpncpy(...)
          - pattern-not-inside: |
              wcpncpy($DST, $SRC, $N);
              ...
              $DST[$POS] = NULL;
          - pattern-not-inside: |
              wcpncpy($DST, $SRC, $N);
              ...
              $DST[$POS] = '\0';
          - pattern-not-inside: |
              wcpncpy($DST, $SRC, $N);
              ...
              $DST[$POS] = 0;
