rules:
  - id: raptor-integer-truncation
    metadata:
      author: Marco Ivaldi <raptor@0xdeadbeef.info>
      references:
        - https://cwe.mitre.org/data/definitions/197
        - https://cwe.mitre.org/data/definitions/681
        - https://g.co/kgs/PCHQjJ
        - https://github.com/struct/mms
      confidence: LOW
      # NOTE: the deep expression operator is necessary to catch some
      # matches because C/C++ integer promotions do not seem entirely
      # supported by Semgrep; this may generate lots of false positives.
      # NOTE: some types (e.g., pointers) and use cases (e.g., comparisons)
      # are not covered.
    message: >-
      Truncation errors occur when a primitive is cast to a primitive of a 
      smaller size and data is lost in the conversion. The value cannot be 
      trusted and the application will be in an undefined state.
    severity: WARNING
    languages:
      - c
      - cpp
    pattern-either:
      # char: assignments
      - patterns:
          - pattern-either:
              - pattern: (char $_) = <... (short $_) ...>
              - pattern: (char $_) = <... (short int $_) ...>
              - pattern: (char $_) = <... (unsigned short $_) ...>
              - pattern: (char $_) = <... (unsigned short int $_) ...>
              - pattern: (char $_) = <... (int $_) ...>
              - pattern: (char $_) = <... (unsigned $_) ...>
              - pattern: (char $_) = <... (unsigned int $_) ...>
              - pattern: (char $_) = <... (long $_) ...>
              - pattern: (char $_) = <... (long int $_) ...>
              - pattern: (char $_) = <... (unsigned long $_) ...>
              - pattern: (char $_) = <... (unsigned long int $_) ...>
          - pattern-not: $_ = 0
      # char: function return
      - patterns:
          - pattern-either:
              - pattern: |
                  char $FUN(...)
                  {
                  ...
                  return (short $_);
                  }
              - pattern: |
                  char $FUN(...)
                  {
                  ...
                  return (int $_);
                  }
              - pattern: |
                  char $FUN(...)
                  {
                  ...
                  return (long $_);
                  }
          # improve output readability
          - focus-metavariable: $FUN
      # short: assignments
      - patterns:
          - pattern-either:
              - pattern: (short $_) = <... (unsigned short $_) ...>
              - pattern: (short int $_) = <... (unsigned short int $_) ...>
              - pattern: (short $_) = <... (int $_) ...>
              - pattern: (short $_) = <... (unsigned $_) ...>
              - pattern: (short int $_) = <... (unsigned int $_) ...>
              - pattern: (short $_) = <... (long $_) ...>
              - pattern: (short int $_) = <... (long int $_) ...>
              - pattern: (short $_) = <... (unsigned long $_) ...>
              - pattern: (short int $_) = <... (unsigned long int $_) ...>
              - pattern: (unsigned short $_) = <... (int $_) ...>
              - pattern: (unsigned short int $_) = <... (unsigned int $_) ...>
              - pattern: (unsigned short $_) = <... (long $_) ...>
              - pattern: (unsigned short int $_) = <... (long int $_) ...>
              - pattern: (unsigned short $_) = <... (unsigned long $_) ...>
              - pattern: (unsigned short int $_) = <... (unsigned long int $_) ...>
          - pattern-not: $_ = 0
      # short: function return
      - patterns:
          - pattern-either:
              - pattern: |
                  short $FUN(...)
                  {
                  ...
                  return (int $_);
                  }
              - pattern: |
                  short $FUN(...)
                  {
                  ...
                  return (long $_);
                  }
          # improve output readability
          - focus-metavariable: $FUN
      # int: assignments
      - patterns:
          - pattern-either:
              - pattern: (int $_) = <... (unsigned $_) ...>
              - pattern: (int $_) = <... (unsigned int $_) ...>
              - pattern: (int $_) = <... (long $_) ...>
              - pattern: (int $_) = <... (long int $_) ...>
              - pattern: (int $_) = <... (unsigned long $_) ...>
              - pattern: (int $_) = <... (unsigned long int $_) ...>
          - pattern-not: $_ = 0
      # int: function return
      - patterns:
          - pattern: |
              int $FUN(...)
              {
              ...
              return (long $_);
              }
          # improve output readability
          - focus-metavariable: $FUN
      # long: assignments
      - patterns:
          - pattern-either:
              - pattern: (long $_) = <... (unsigned long $_) ...>
              - pattern: (long int $_) = <... (unsigned long int $_) ...>
          - pattern-not: $_ = 0
