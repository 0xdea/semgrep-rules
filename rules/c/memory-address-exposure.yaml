rules:
  - id: raptor-memory-address-exposure
    metadata:
      author: Marco Ivaldi <raptor@0xdeadbeef.info>
      references:
        - https://cwe.mitre.org/data/definitions/200
        - https://cwe.mitre.org/data/definitions/209
        - https://cwe.mitre.org/data/definitions/497
        - https://github.com/struct/mms
      confidence: LOW
      # NOTE: `#define` format specifiers are not considered due to Semgrep 
      # limitations, perhaps we could implement this with symbolic propagation
      # (Semgrep Pro experimental feature)?
    message: >-
      The software generates an error message that includes sensitive
      information about its environment, users, or associated data.
      In particular, exposure of memory addresses might defeat ASLR.
    severity: INFO
    languages:
      - c
      - cpp
    patterns:
      - pattern-either:
          # format string in 1st arg
          - pattern: printf($FMT, ...)
          - pattern: vprintf($FMT, ...)
          - pattern: wprintf($FMT, ...)
          - pattern: vwprintf($FMT, ...)
          - pattern: vcprintf($FMT, ...)
          - pattern: vcwprintf($FMT, ...)
          - pattern: vscprintf($FMT, ...)
          - pattern: vscwprintf($FMT, ...)
          # format string in 2nd arg
          - pattern: fprintf($_, $FMT, ...)
          - pattern: vfprintf($_, $FMT, ...)
          - pattern: fwprintf($_, $FMT, ...)
          - pattern: vfwprintf($_, $FMT, ...)
          - pattern: sprintf($_, $FMT, ...)
          - pattern: vsprintf($_, $FMT, ...)
          - pattern: asprintf($_, $FMT, ...)
          - pattern: vasprintf($_, $FMT, ...)
          - pattern: dprintf($_, $FMT, ...)
          - pattern: vdprintf($_, $FMT, ...)
          - pattern: wsprintf($_, $FMT, ...)
          # format string in 3rd arg
          - pattern: snprintf($_, $_, $FMT, ...)
          - pattern: vsnprintf($_, $_, $FMT, ...)
          - pattern: swprintf($_, $_, $FMT, ...)
          - pattern: vswprintf($_, $_, $FMT, ...)
      - metavariable-regex:
          metavariable: $FMT
          # NOTE: some format string specifiers are not handled
          regex: '(".*%\w*x.*"|".*%\w*X.*"|".*%\w*p.*")'
