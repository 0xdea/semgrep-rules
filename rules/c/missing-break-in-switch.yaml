rules:
  - id: raptor-missing-break-in-switch
    metadata:
      author: Marco Ivaldi <raptor@0xdeadbeef.info>
      references:
        - https://cwe.mitre.org/data/definitions/484
        - https://g.co/kgs/PCHQjJ
        - https://github.com/struct/mms
        - https://github.com/returntocorp/semgrep/issues/4939
      confidence: LOW
      # NOTE: we should also check for default blocks that miss the
      # break/return/exit/goto or equivalent statement/function call.
    message: >-
      The software omits a break statement within a switch or similar
      construct, causing code associated with multiple conditions to
      execute. This can cause problems when the programmer only intended to
      execute code associated with one condition.
    severity: INFO
    languages:
      - c
      - cpp
    patterns:
      - pattern: |
          switch ($VAR) { case $_: ... case $_: ... }
      # break
      - pattern-not: |
          switch ($VAR) { case $_: ... break; case $_: ... }
      - pattern-not: |
          switch ($VAR) { case $_: break; case $_: ... }
      # exit
      - pattern-not: |
          switch ($VAR) { case $_: ... exit($_); case $_: ... }
      - pattern-not: |
          switch ($VAR) { case $_: exit($_); case $_: ... }
      # return
      - pattern-not: |
          switch ($VAR) { case $_: ... return; case $_: ... }
      - pattern-not: |
          switch ($VAR) { case $_: return; case $_: ... }
      - pattern-not: |
          switch ($VAR) { case $_: ... return $_; case $_: ... }
      - pattern-not: |
          switch ($VAR) { case $_: return $_; case $_: ... }
      # goto
      - pattern-not: |
          switch ($VAR) { case $_: ... goto $_; case $_: ... }
      - pattern-not: |
          switch ($VAR) { case $_: goto $_; case $_: ... }
      # throw (C++)
      # - pattern-not: |
      #     switch ($_) { case $_: ... throw $_; case $_: ... }
      # - pattern-not: |
      #     switch ($_) { case $_: throw $_; case $_: ... }      
      # improve output readability
      - focus-metavariable: $VAR
