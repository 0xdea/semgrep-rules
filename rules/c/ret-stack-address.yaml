rules:
  - id: raptor-ret-stack-address
    metadata:
      author: Marco Ivaldi <raptor@0xdeadbeef.info>
      references:
        - https://cwe.mitre.org/data/definitions/562
        - https://github.com/struct/mms
        - https://www.sei.cmu.edu/downloads/sei-cert-c-coding-standard-2016-v01.pdf
        - https://docs.microsoft.com/en-us/cpp/sanitizers/asan-error-examples
        - https://rules.sonarsource.com/c/type/Bug/RSPEC-946
      confidence: MEDIUM
      # NOTE: global variables declared outside functions and not explicitly
      # tagged as static are not supported.
      # NOTE: multiple pointer assignments and other ways to persist after
      # function returns (e.g., output parameter) are not covered.
    message: >-
      A function returns the address of a stack variable, which will cause
      unintended program behavior, typically in the form of a crash.
    severity: INFO
    languages:
      - c
      - cpp
    pattern-either:
      - patterns:
          - pattern: return $PTR;
          - pattern-either:
              # array
              - pattern-inside: |
                  $_ $PTR[$_];
                  ...
              - pattern-inside: |
                  $_ $PTR[$_] = $_;
                  ...
              # pointer to array
              - pattern-inside: |
                  $_ $ARR[$_];
                  ...
                  $PTR = $ARR;
                  ...
              - pattern-inside: |
                  $_ $ARR[$_] = $_;
                  ...
                  $PTR = $ARR;
                  ...
          # exclude static variables
          - pattern-not-inside: |
              static $_ $PTR[$_];
              ...
          - pattern-not-inside: |
              static $_ $PTR[$_] = $_;
              ...
          - pattern-not-inside: |
              static $_ $ARR[$_];
              ...
          - pattern-not-inside: |
              static $_ $ARR[$_] = $_;
              ...
      - patterns:
          # address of local variable
          - pattern: return &$VAR;
          - pattern-either:
              - pattern-inside: |
                  $_ $VAR;
                  ...
              - pattern-inside: |
                  $_ $VAR = $_;
                  ...
              - pattern-inside: |
                  $_ $VAR[$_];
                  ...
              - pattern-inside: |
                  $_ $VAR[$_] = $_;
                  ...
              - pattern-inside: |
                  $_ * $VAR;
                  ...
              - pattern-inside: |
                  $_ * $VAR = $_;
                  ...
          # exclude static variables
          - pattern-not-inside: |
              static $_ $VAR;
              ...
          - pattern-not-inside: |
              static $_ $VAR = $_;
              ...
          - pattern-not-inside: |
              static $_ $VAR[$_];
              ...
          - pattern-not-inside: |
              static $_ $VAR[$_] = $_;
              ...
          - pattern-not-inside: |
              static $_ * $VAR;
              ...
          - pattern-not-inside: |
              static $_ * $VAR = $_;
              ...
