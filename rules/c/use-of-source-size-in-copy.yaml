rules:
  - id: raptor-use-of-source-size-in-copy
    metadata:
      author: Marco Ivaldi <raptor@0xdeadbeef.info>
      references:
        - https://cwe.mitre.org/data/definitions/806
        - https://github.com/0xdea/advisories/blob/master/2020-07-solaris-whodo-w.txt
        - https://dustri.org/b/playing-with-weggli.html
      confidence: MEDIUM
      # NOTE: some copy functions such as `memccpy`, `bcopy`, and `strcpy_s` are not covered.
      # NOTE: `strlen` before the copy function is not covered.
      # NOTE: structs are not covered.
    message: >-
      The software uses the size of a source buffer when reading from or
      writing to a destination buffer, which may cause it to access memory
      that is outside of the bounds of the buffer.
    severity: ERROR
    languages:
      - c
      - cpp
    pattern-either:
      # size of array
      - patterns:
          - pattern: $FUN($DST, $SRC, $LEN)
          - pattern-not: $FUN($DST, "...", $LEN)
          - metavariable-pattern:
              metavariable: $FUN
              pattern-either:
                - pattern: strncpy
                - pattern: stpncpy
                - pattern: strlcpy
                - pattern: strscpy
                - pattern: memcpy
                - pattern: memmove
                - pattern: wmemcpy
                - pattern: wmemmove
                - pattern: mempcpy
                - pattern: wmempcpy
          - pattern-either:
              - patterns:
                  - pattern-inside: |
                      $_ $SRC[$LEN];
                      ...
                  - pattern-not-inside: |
                      $_ $DST[$LEN];
                      ...
                  - pattern-not-inside: |
                      $_ $DST[$LEN] = ...;
                      ...
              - patterns:
                  - pattern-inside: |
                      $_ $SRC[$LEN] = ...;
                      ...
                  - pattern-not-inside: |
                      $_ $DST[$LEN];
                      ...
                  - pattern-not-inside: |
                      $_ $DST[$LEN] = ...;
                      ...
      # sizeof operator, strlen, and similar
      - patterns:
          - pattern: $FUN($DST, $SRC, <... $SRC ...>)
          - pattern-not: $FUN($DST, "...", <... $SRC ...>)
          # - pattern-not: $FUN($DST, $SRC, <... $DST ...>)
          - metavariable-pattern:
              metavariable: $FUN
              pattern-either:
                - pattern: strncpy
                - pattern: stpncpy
                - pattern: strlcpy
                - pattern: strscpy
                - pattern: memcpy
                - pattern: memmove
                - pattern: wmemcpy
                - pattern: wmemmove
                - pattern: mempcpy
                - pattern: wmempcpy
      # snprintf
      - patterns:
          - pattern: $FUN($DST, <... $SRC ...>, ..., $SRC, ...)
          # - pattern-not: $FUN($DST, <... $DST ...>, ..., $SRC, ...)
          - metavariable-pattern:
              metavariable: $FUN
              pattern-either:
                - pattern: snprintf
                - pattern: vsnprintf
                - pattern: swprintf
                - pattern: vswprintf
